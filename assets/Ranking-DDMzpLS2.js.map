{"version":3,"file":"Ranking-DDMzpLS2.js","sources":["../../src/hooks/usePreferencesMutation.ts","../../src/features/ranking/components/RankingList.tsx","../../src/features/ranking/Ranking.tsx"],"sourcesContent":["import type { ApiInputs, ApiOutputs } from '@/api/trpc/router';\nimport { type UseMutationResult, useMutation, useQueryClient } from '@tanstack/react-query';\n\nimport { api } from 'utils/trpc';\n\nexport const usePreferencesMutation = (): UseMutationResult<\n  ApiOutputs['user']['preferencesMutation'],\n  unknown,\n  ApiInputs['user']['preferencesMutation'],\n  undefined\n> => {\n  const queryClient = useQueryClient();\n\n  const preferencesMutation = useMutation(\n    api.user.preferencesMutation.mutationOptions({\n      onSuccess: (newUser) => {\n        queryClient.setQueryData(api.user.current.queryKey(), newUser);\n        queryClient.invalidateQueries(api.charts.search.infiniteQueryFilter());\n      },\n    })\n  );\n\n  return preferencesMutation;\n};\n","import type { ApiOutputs } from '@/api/trpc/router';\nimport { Anchor, Flex, Switch } from '@mantine/core';\nimport classNames from 'classnames';\nimport _ from 'lodash/fp';\nimport { GiQueenCrown } from 'react-icons/gi';\nimport { NavLink } from 'react-router-dom';\n\nimport { ExpRankImg } from 'components/ExpRankImg/ExpRankImg';\nimport { Flag } from 'components/Flag/Flag';\nimport Loader from 'components/Loader/Loader';\n\nimport { routes } from 'constants/routes';\n\nimport { usePreferencesMutation } from 'hooks/usePreferencesMutation';\n\nimport { useLanguage } from 'utils/context/translation';\n\ntype PlayerStats = ApiOutputs['players']['stats'][number];\ntype UserData = ApiOutputs['user']['current'];\ntype Preferences = NonNullable<UserData>['preferences'];\n\ninterface RankingListProps {\n  ranking: PlayerStats[] | undefined;\n  isLoading: boolean;\n  preferences: Preferences | undefined;\n}\n\nexport default function RankingList({ ranking, isLoading, preferences }: RankingListProps) {\n  const lang = useLanguage();\n  const preferencesMutation = usePreferencesMutation();\n\n  return (\n    <div className=\"ranking-list\">\n      {_.isEmpty(ranking) && !isLoading && 'ничего не найдено'}\n      {isLoading && <Loader />}\n      {!isLoading && ranking && (\n        <table>\n          <thead>\n            <tr>\n              <th className=\"place\">{lang.RANK}</th>\n              <th>{lang.EXP}</th>\n              <th className=\"name\">{lang.NAME}</th>\n              <th className=\"name name-piu\">{lang.AMPASS}</th>\n              <th className=\"rating\">pp</th>\n              <th className=\"playcount\">{lang.PLAYCOUNT}</th>\n              <th className=\"playcount\">{lang.SCORES_count}</th>\n              <th className=\"accuracy\">{lang.ACCURACY}</th>\n              <th className=\"hide-col\"> </th>\n            </tr>\n          </thead>\n          <tbody>\n            {ranking.map((player, playerIndex) => {\n              const isHidden = preferences?.playersHiddenStatus?.[player.id];\n              const isRegionHidden = player.region && preferences?.hiddenRegions?.[player.region];\n              if ((isHidden || isRegionHidden) && !preferences?.showHiddenPlayersInRanking) {\n                return null;\n              }\n\n              return (\n                <tr className={classNames('player', { 'hidden-player': isHidden || isRegionHidden })} key={player.id}>\n                  <td className=\"place\">\n                    {playerIndex === 0 ? <GiQueenCrown /> : `#${playerIndex + 1}`}\n                  </td>\n                  <td className=\"exp-rank\">{player.exp != null ? <ExpRankImg exp={player.exp} /> : null}</td>\n                  <td className=\"name\">\n                    <Flex gap=\"xxs\" align=\"center\">\n                      {player.region ? <Flag region={player.region} /> : null}\n                      <Anchor component={NavLink} to={routes.profile.getPath({ id: player.id })}>\n                        {player.nickname}\n                      </Anchor>\n                    </Flex>\n                  </td>\n                  <td className=\"name name-piu\">\n                    <Anchor component={NavLink} to={routes.profile.getPath({ id: player.id })}>\n                      {player.arcade_name}\n                    </Anchor>\n                  </td>\n                  <td className=\"rating secondary\">\n                    {player.pp != null ? Math.floor(player.pp) : ''}\n                  </td>\n                  <td className=\"playcount\">{player.results_count}</td>\n                  <td className=\"playcount\">{player.best_results_count}</td>\n                  <td className=\"accuracy\">\n                    {player.accuracy ? `${player.accuracy.toFixed(2)}%` : ''}\n                  </td>\n                  <td className=\"hide-col\">\n                    <div className=\"switch-wrapper\">\n                      <Switch\n                        onChange={() => {\n                          if (preferences) {\n                            preferencesMutation.mutate(\n                              _.set(['playersHiddenStatus', player.id], !isHidden, preferences)\n                            );\n                          }\n                        }}\n                        checked={!isHidden}\n                      />\n                    </div>\n                  </td>\n                </tr>\n              );\n            })}\n          </tbody>\n        </table>\n      )}\n    </div>\n  );\n}\n","import {\n  ActionIcon,\n  Button,\n  CheckIcon,\n  Group,\n  Modal,\n  MultiSelect,\n  Stack,\n  Switch,\n} from '@mantine/core';\nimport { useDisclosure } from '@mantine/hooks';\nimport { useQuery } from '@tanstack/react-query';\nimport _ from 'lodash/fp';\nimport { useMemo } from 'react';\nimport { FaCog, FaSync } from 'react-icons/fa';\n\nimport './ranking.scss';\n\nimport { Flag } from 'components/Flag/Flag';\n\nimport { usePreferencesMutation } from 'hooks/usePreferencesMutation';\nimport { useUser } from 'hooks/useUser';\n\nimport { useLanguage } from 'utils/context/translation';\nimport { api } from 'utils/trpc';\n\nimport RankingList from './components/RankingList';\n\nconst Ranking = () => {\n  const lang = useLanguage();\n  const userQuery = useUser();\n  const [settingsOpened, { open: openSettings, close: closeSettings }] = useDisclosure(false);\n  const {\n    isLoading,\n    isFetching,\n    error,\n    data: ranking,\n    refetch: refetchRanking,\n  } = useQuery(api.players.stats.queryOptions());\n\n  const preferencesMutation = usePreferencesMutation();\n  const preferences = userQuery.data?.preferences;\n\n  const availableRegions = useMemo(() => {\n    if (!ranking) return [];\n    const regions = ranking\n      .map((player) => player.region)\n      .filter((region): region is string => region !== null);\n    return [...new Set(regions)].sort();\n  }, [ranking]);\n\n  const hiddenRegions = useMemo(() => {\n    if (!preferences?.hiddenRegions) return [];\n    return Object.entries(preferences.hiddenRegions)\n      .filter(([, isHidden]) => isHidden)\n      .map(([region]) => region);\n  }, [preferences?.hiddenRegions]);\n\n  const onChangeHidingPlayers = () => {\n    if (preferences) {\n      preferencesMutation.mutate(\n        _.set(['showHiddenPlayersInRanking'], !preferences.showHiddenPlayersInRanking, preferences)\n      );\n    }\n  };\n\n  const onChangeHiddenRegions = (selectedRegions: string[]) => {\n    if (preferences) {\n      const newHiddenRegions = availableRegions.reduce<Record<string, boolean>>((acc, region) => {\n        acc[region] = selectedRegions.includes(region);\n        return acc;\n      }, {});\n      preferencesMutation.mutate(_.set(['hiddenRegions'], newHiddenRegions, preferences));\n    }\n  };\n\n  const onRefresh = () => {\n    if (!isLoading) {\n      refetchRanking();\n    }\n  };\n\n  return (\n    <div className=\"ranking-page\">\n      <div className=\"content\">\n        {error && error.message}\n        <div className=\"top-controls\">\n          <Button size=\"sm\" disabled={isFetching} onClick={onRefresh} leftSection={<FaSync />}>\n            {lang.UPDATE}\n          </Button>\n          <ActionIcon\n            variant=\"subtle\"\n            size=\"lg\"\n            onClick={openSettings}\n            disabled={!preferences}\n            ml=\"auto\"\n          >\n            <FaCog />\n          </ActionIcon>\n        </div>\n        <RankingList ranking={ranking} isLoading={isLoading} preferences={preferences} />\n      </div>\n\n      <Modal opened={settingsOpened} onClose={closeSettings} title={lang.FILTERS} centered>\n        <Stack>\n          <Switch\n            label={lang.SHOW_ALL}\n            checked={preferences?.showHiddenPlayersInRanking ?? false}\n            onChange={onChangeHidingPlayers}\n            disabled={!preferences}\n          />\n          <MultiSelect\n            label={lang.HIDE_COUNTRIES}\n            placeholder={lang.HIDE_COUNTRIES}\n            data={availableRegions}\n            value={hiddenRegions}\n            onChange={onChangeHiddenRegions}\n            disabled={!preferences}\n            clearable\n            searchable\n            renderOption={({ option, checked }) => (\n              <Group gap=\"xs\">\n                {checked && <CheckIcon size={12} />}\n                <Flag region={option.value} size=\"sm\" />\n                {option.value}\n              </Group>\n            )}\n          />\n        </Stack>\n      </Modal>\n    </div>\n  );\n};\n\nexport default Ranking;\n"],"names":["usePreferencesMutation","queryClient","useQueryClient","useMutation","api","newUser","RankingList","ranking","isLoading","preferences","lang","useLanguage","preferencesMutation","jsxs","_","Loader","jsx","player","playerIndex","isHidden","isRegionHidden","classNames","GiQueenCrown","ExpRankImg","Flex","Flag","Anchor","NavLink","routes","Switch","Ranking","userQuery","useUser","settingsOpened","openSettings","closeSettings","useDisclosure","isFetching","error","refetchRanking","useQuery","availableRegions","useMemo","regions","region","hiddenRegions","onChangeHidingPlayers","onChangeHiddenRegions","selectedRegions","newHiddenRegions","acc","onRefresh","Button","FaSync","ActionIcon","FaCog","Modal","Stack","MultiSelect","option","checked","Group","CheckIcon"],"mappings":"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"}